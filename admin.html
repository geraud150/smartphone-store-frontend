<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Smartphone Store</title>
    <!-- Bootstrap 5 pour un design moderne -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #007bff; --danger: #dc3545; --success: #28a745; --dark: #343a40; }
        body { background-color: #f4f7f6; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        
        .admin-card { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        
        #imagePreview { 
            max-width: 100%; 
            height: 200px; 
            object-fit: contain; 
            display: none; 
            margin-top: 15px; 
            border: 2px dashed #ddd; 
            border-radius: 8px; 
            background: #fafafa;
        }

        /* Tableau des produits */
        .table-container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .product-img-td { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; }
        
        .btn-action { padding: 5px 12px; font-size: 0.85rem; font-weight: bold; }
        
        #cancel-btn { display: none; }
    </style>
</head>
<body>

<div class="admin-card">
    <h2 class="text-center mb-4" id="form-title">Ajouter un Produit</h2>
    
    <form id="productForm">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Nom du smartphone *</label>
                <input type="text" class="form-control" id="nom" required placeholder="ex: iPhone 15 Pro">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Prix (FCFA / €) *</label>
                <input type="number" class="form-control" id="prix" step="0.01" required placeholder="Montant">
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Catégorie</label>
                <select class="form-select" id="categorie">
                    <option value="smartphone">Smartphone</option>
                    <option value="tablette">Tablette</option>
                    <option value="accessoire">Accessoire</option>
                    <option value="laptop">Ordinateur Portable</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Sélectionner l'image</label>
                <input type="file" class="form-control" id="imageFile" accept="image/*">
                <small class="text-muted" id="image-hint">Obligatoire pour un nouvel ajout</small>
            </div>
        </div>

        <div class="text-center">
            <img id="imagePreview" src="#" alt="Aperçu du produit">
        </div>

        <div class="mb-3 mt-3">
            <label class="form-label fw-bold">Description générale</label>
            <textarea class="form-control" id="description" rows="3" placeholder="Texte de présentation..."></textarea>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">RAM</label>
                <input type="text" class="form-control" id="ram" placeholder="ex: 8 Go">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Stockage</label>
                <input type="text" class="form-control" id="stockage" placeholder="ex: 128 Go">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Batterie</label>
                <input type="text" class="form-control" id="batterie" placeholder="ex: 5000 mAh">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Appareil photo</label>
                <input type="text" class="form-control" id="appareil_photo" placeholder="ex: 50 MP">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Écran</label>
                <input type="text" class="form-control" id="ecran" placeholder='ex: 6.5" AMOLED'>
            </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 py-2 fw-bold" id="btnSubmit">Ajouter au catalogue</button>
        <button type="button" class="btn btn-secondary w-100 mt-2" id="cancel-btn" onclick="resetForm()">Annuler la modification</button>
    </form>
    
    <div id="statusMessage" class="mt-3"></div>
</div>

<!-- Liste des produits pour gestion -->
<div class="table-container">
    <h3 class="mb-4">Gestion du Catalogue</h3>
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Image</th>
                    <th>Nom</th>
                    <th>Prix</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="products-list">
                <!-- Chargé dynamiquement par JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = 'https://smartphone-store-backend.onrender.com/api/products';
    const imageInput = document.getElementById('imageFile');
    const imagePreview = document.getElementById('imagePreview');
    const statusMsg = document.getElementById('statusMessage');
    const btnSubmit = document.getElementById('btnSubmit');
    const cancelBtn = document.getElementById('cancel-btn');
    
    let editingId = null;

    // --- 1. APERÇU DE L'IMAGE ---
    imageInput.onchange = () => {
        const [file] = imageInput.files;
        if (file) {
            imagePreview.src = URL.createObjectURL(file);
            imagePreview.style.display = 'inline-block';
        }
    };

    // --- 2. CHARGER LES PRODUITS ---
    async function loadProducts() {
        try {
            const res = await fetch(API_URL);
            const products = await res.json();
            const list = document.getElementById('products-list');
            
            list.innerHTML = products.map(p => `
                <tr>
                    <td><img src="https://smartphone-store-backend.onrender.com${p.url_image}" class="product-img-td" onerror="this.src='https://placehold.co/60x60?text=Err'"></td>
                    <td><strong>${p.nom}</strong><br><small class="text-muted">${p.categorie}</small></td>
                    <td>${parseFloat(p.prix).toLocaleString()}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success btn-action" onclick='prepareEdit(${JSON.stringify(p).replace(/'/g, "&apos;")})'>Editer</button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteProduct(${p.id_produit})">Supprimer</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            console.error("Erreur chargement:", err);
        }
    }

    // --- 3. PRÉPARER LA MODIFICATION ---
    function prepareEdit(p) {
        editingId = p.id_produit;
        document.getElementById('form-title').innerText = "Modifier : " + p.nom;
        btnSubmit.innerText = "Mettre à jour le produit";
        btnSubmit.classList.replace('btn-primary', 'btn-success');
        cancelBtn.style.display = "block";
        document.getElementById('image-hint').innerText = "Laisser vide pour garder l'image actuelle";

        // Remplissage
        document.getElementById('nom').value = p.nom;
        document.getElementById('prix').value = p.prix;
        document.getElementById('categorie').value = p.categorie;
        document.getElementById('description').value = p.description || '';
        document.getElementById('ram').value = p.ram || '';
        document.getElementById('stockage').value = p.stockage || '';
        document.getElementById('batterie').value = p.batterie || '';
        document.getElementById('appareil_photo').value = p.appareil_photo || '';
        document.getElementById('ecran').value = p.ecran || '';

        // Aperçu de l'image actuelle
        imagePreview.src = `https://smartphone-store-backend.onrender.com${p.url_image}`;
        imagePreview.style.display = 'inline-block';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- 4. RÉINITIALISER ---
    function resetForm() {
        editingId = null;
        document.getElementById('productForm').reset();
        document.getElementById('form-title').innerText = "Ajouter un Produit";
        btnSubmit.innerText = "Ajouter au catalogue";
        btnSubmit.classList.replace('btn-success', 'btn-primary');
        cancelBtn.style.display = "none";
        imagePreview.style.display = 'none';
        document.getElementById('image-hint').innerText = "Obligatoire pour un nouvel ajout";
        statusMsg.innerHTML = "";
    }

    // --- 5. SUPPRIMER ---
    async function deleteProduct(id) {
        if (!confirm("Supprimer ce produit définitivement ?")) return;
        const token = localStorage.getItem('userToken');

        try {
            const res = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            alert(data.message);
            loadProducts();
        } catch (err) {
            alert("Erreur de suppression");
        }
    }

    // --- 6. SOUMISSION (POST ou PUT) ---
    document.getElementById('productForm').onsubmit = async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('userToken');

        if (!token) {
            statusMsg.innerHTML = `<div class="alert alert-danger">Erreur : Vous devez être connecté.</div>`;
            return;
        }

        const formData = new FormData();
        formData.append('nom', document.getElementById('nom').value);
        formData.append('prix', document.getElementById('prix').value);
        formData.append('categorie', document.getElementById('categorie').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('ram', document.getElementById('ram').value);
        formData.append('stockage', document.getElementById('stockage').value);
        formData.append('batterie', document.getElementById('batterie').value);
        formData.append('appareil_photo', document.getElementById('appareil_photo').value);
        formData.append('ecran', document.getElementById('ecran').value);

        if (imageInput.files[0]) {
            formData.append('productImage', imageInput.files[0]);
        } else if (!editingId) {
            alert("Veuillez sélectionner une image.");
            return;
        }

        const method = editingId ? 'PUT' : 'POST';
        const url = editingId ? `${API_URL}/${editingId}` : API_URL;

        btnSubmit.disabled = true;
        btnSubmit.innerText = "Opération en cours...";

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            const resData = await response.json();

            if (response.ok) {
                statusMsg.innerHTML = `<div class="alert alert-success">✅ ${resData.message}</div>`;
                resetForm();
                loadProducts();
            } else {
                statusMsg.innerHTML = `<div class="alert alert-danger">❌ ${resData.message}</div>`;
            }
        } catch (err) {
            statusMsg.innerHTML = `<div class="alert alert-danger">Erreur de connexion serveur.</div>`;
        } finally {
            btnSubmit.disabled = false;
            btnSubmit.innerText = editingId ? "Mettre à jour le produit" : "Ajouter au catalogue";
        }
    };

    // Initialisation
    window.onload = loadProducts;
</script>

</body>
</html>
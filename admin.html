<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Smartphone Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 20px; }
        .admin-card { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #imagePreview { max-width: 100%; height: 200px; object-fit: contain; display: none; margin-top: 15px; border: 2px dashed #ddd; border-radius: 8px; }
    </style>
</head>
<body>

<div class="admin-card">
    <h2 class="text-center mb-4">Ajouter un Produit</h2>
    <form id="productForm">
        <div class="mb-3">
            <label class="form-label fw-bold">Nom du smartphone</label>
            <input type="text" class="form-control" id="nom" required placeholder="ex: iPhone 15 Pro">
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Catégorie</label>
            <select class="form-select" id="categorie">
                <option value="smartphone">Smartphone</option>
                <option value="laptop">Ordinateur Portable</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Prix (FCFA)</label>
            <input type="number" class="form-control" id="prix" required placeholder="Montant">
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Sélectionner l'image</label>
            <input type="file" class="form-control" id="imageFile" accept="image/*" required>
            <img id="imagePreview" src="#" alt="Aperçu du produit">
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Description générale</label>
            <textarea class="form-control" id="description" rows="3" placeholder="Texte de présentation..."></textarea>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">RAM</label>
                <input type="text" class="form-control" id="ram" placeholder="ex: 8 Go">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Stockage</label>
                <input type="text" class="form-control" id="stockage" placeholder="ex: 128 Go">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Batterie</label>
                <input type="text" class="form-control" id="batterie" placeholder="ex: 5000 mAh">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Appareil photo</label>
                <input type="text" class="form-control" id="appareil_photo" placeholder="ex: 50 MP">
            </div>
            <div class="col-md-12 mb-3">
                <label class="form-label fw-bold">Écran</label>
                <input type="text" class="form-control" id="ecran" placeholder='ex: 6.5" AMOLED'>
            </div>
        </div>

        <button type="submit" class="btn btn-primary w-100" id="btnSubmit">Ajouter au catalogue</button>
    </form>
    <div id="statusMessage" class="mt-3"></div>
</div>

<script>
    const imageInput = document.getElementById('imageFile');
    const imagePreview = document.getElementById('imagePreview');

    // Aperçu de l'image avant l'envoi
    imageInput.onchange = () => {
        const [file] = imageInput.files;
        if (file) {
            imagePreview.src = URL.createObjectURL(file);
            imagePreview.style.display = 'block';
        }
    };

    document.getElementById('productForm').onsubmit = async (e) => {
        e.preventDefault();
        const msg = document.getElementById('statusMessage');
        const btn = document.getElementById('btnSubmit');
        
        // --- RÉCUPÉRATION DU TOKEN ---
        // On suppose que le token est stocké dans le localStorage après la connexion
        const token = localStorage.getItem('userToken');

        if (!token) {
            msg.innerHTML = `<div class="alert alert-danger">Erreur : Vous devez être connecté pour effectuer cette action.</div>`;
            return;
        }

        const formData = new FormData();
        formData.append('nom', document.getElementById('nom').value);
        formData.append('categorie', document.getElementById('categorie').value);
        formData.append('prix', document.getElementById('prix').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('ram', document.getElementById('ram').value);
        formData.append('stockage', document.getElementById('stockage').value);
        formData.append('batterie', document.getElementById('batterie').value);
        formData.append('appareil_photo', document.getElementById('appareil_photo').value);
        formData.append('ecran', document.getElementById('ecran').value);
        formData.append('productImage', imageInput.files[0]);

        btn.disabled = true;
        btn.innerText = "Téléchargement en cours...";

        try {
            const response = await fetch('https://smartphone-store-backend.onrender.com/api/products', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}` // Transmission du jeton de sécurité
                },
                body: formData
            });

            const res = await response.json();

            if (response.ok) {
                msg.innerHTML = `<div class="alert alert-success">✅ ${res.message}</div>`;
                e.target.reset();
                imagePreview.style.display = 'none';
            } else {
                msg.innerHTML = `<div class="alert alert-danger">❌ ${res.message || 'Une erreur est survenue'}</div>`;
            }
        } catch (err) {
            console.error(err);
            msg.innerHTML = `<div class="alert alert-danger">Erreur critique : Impossible de joindre le serveur.</div>`;
        } finally {
            btn.disabled = false;
            btn.innerText = "Ajouter au catalogue";
        }
    };
</script>
</body>
</html>